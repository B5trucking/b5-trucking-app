<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>B5 Trucking Admin Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --brand-primary: #dc2626;
      --brand-light: #fee2e2;
      --brand-gradient: linear-gradient(135deg, #fca5a5 0%, #dc2626 100%);
      --bg-main: #f5f7fb;
      --bg-surface: #ffffff;
      --text-primary: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --sidebar-width: 260px;
      --gradient-orange: linear-gradient(135deg, #fed7aa 0%, #f97316 100%);
      --gradient-blue: linear-gradient(135deg, #bfdbfe 0%, #3b82f6 100%);
      --gradient-green: linear-gradient(135deg, #a7f3d0 0%, #10b981 100%);
      --gradient-red: linear-gradient(135deg, #fecaca 0%, #dc2626 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
    }

    /* ADMIN LOGIN SCREEN */
    .admin-login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: var(--bg-main);
    }

    .admin-login-screen.hidden {
      display: none;
    }

    .login-container {
      background: var(--bg-surface);
      border-radius: 20px;
      padding: 48px 40px;
      max-width: 440px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border);
      text-align: center;
    }

    .login-logo {
      width: 72px;
      height: 72px;
      margin: 0 auto 20px;
      background: var(--brand-gradient);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 32px;
      font-weight: 700;
    }

    .login-container h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .login-container .subtitle {
      color: var(--text-muted);
      font-size: 15px;
      margin-bottom: 32px;
    }

    .error-msg {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 10px;
      margin-top: 16px;
      display: none;
      font-size: 14px;
      border: 1px solid #fecaca;
    }

    .admin-link {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .admin-link a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .admin-link a:hover {
      color: var(--brand-primary);
      gap: 6px;
    }

    /* SIDEBAR */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--bg-surface);
      border-right: 1px solid var(--border);
      display: none;
      flex-direction: column;
      z-index: 100;
    }

    .sidebar.show {
      display: flex;
    }

    .logo {
      padding: 24px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--brand-gradient);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 18px;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    .user-profile {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: var(--brand-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .user-role {
      font-size: 12px;
      color: var(--text-muted);
    }

    .nav-menu {
      flex: 1;
      padding: 20px 0;
      overflow-y: auto;
    }

    .nav-item {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: #fafafa;
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--brand-light);
      color: var(--brand-primary);
      border-left-color: var(--brand-primary);
    }

    .nav-icon {
      width: 20px;
      height: 20px;
      opacity: 0.7;
    }

    .nav-item.active .nav-icon {
      opacity: 1;
    }

    /* MAIN CONTENT */
    .main-content {
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      display: none;
    }

    .main-content.show {
      display: block;
    }

    .top-bar {
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .search-bar {
      flex: 1;
      max-width: 400px;
    }

    .search-input {
      width: 100%;
      padding: 10px 16px 10px 40px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 14px;
      background: #fafafa;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 12px center;
    }

    .search-input:focus {
      outline: none;
      background-color: white;
      border-color: var(--brand-primary);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: none;
      background: #fafafa;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: var(--border);
    }

    .mobile-menu-btn {
      display: none;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: none;
      background: #fafafa;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .mobile-menu-btn:hover {
      background: var(--border);
    }

    .mobile-menu-btn svg {
      color: var(--text-primary);
    }

    .content-area {
      padding: 32px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .page-header {
      margin-bottom: 28px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 6px;
      letter-spacing: -0.02em;
    }

    .page-subtitle {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* STAT CARDS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-surface);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    .stat-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0.08;
      border-radius: 16px;
    }

    .stat-card.gradient-1::before {
      background: var(--gradient-red);
    }

    .stat-card.gradient-2::before {
      background: var(--gradient-blue);
    }

    .stat-card.gradient-3::before {
      background: var(--gradient-green);
    }

    .stat-card.gradient-4::before {
      background: var(--gradient-orange);
    }

    .stat-content {
      position: relative;
      z-index: 1;
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .stat-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
    }
    
    .stat-icon svg {
      opacity: 0.8;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .stat-change {
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-change.positive {
      color: #10b981;
    }

    .stat-change.negative {
      color: #ef4444;
    }

    /* TABLES */
    .table-container {
      background: var(--bg-surface);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .table-title {
      font-size: 18px;
      font-weight: 600;
    }

    .table-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--brand-primary);
      color: white;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.25);
    }

    .btn-primary:hover {
      background: #b91c1c;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(220, 38, 38, 0.3);
    }

    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    
    .btn-primary:disabled:hover {
      background: #9ca3af;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #fafafa;
    }

    th {
      padding: 14px 24px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 16px 24px;
      font-size: 14px;
      border-bottom: 1px solid #f3f4f6;
    }

    tbody tr:hover {
      background: #fafafa;
    }

    .badge {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge.success {
      background: #d1fae5;
      color: #065f46;
    }

    .badge.warning {
      background: #fef3c7;
      color: #92400e;
    }

    .badge.danger {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge.info {
      background: #dbeafe;
      color: #1e40af;
    }

    /* FILTERS */
    .filters {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
    }

    .filter-input,
    .filter-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: white;
    }

    .filter-input:focus,
    .filter-select:focus {
      outline: none;
      border-color: var(--brand-primary);
    }

    #monthFilterGroup {
      display: flex;
    }

    /* FORMS */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .form-input,
    .form-select,
    .form-textarea {
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      background: white;
      font-family: inherit;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-helper {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-surface);
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: #f3f4f6;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--text-muted);
    }

    .modal-close:hover {
      background: #e5e7eb;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* INVOICE PREVIEW */
    .invoice-preview {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      margin: 24px 0;
    }

    .invoice-header-section {
      display: flex;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f3f4f6;
    }

    .company-info h2 {
      color: var(--brand-primary);
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: 0.02em;
    }

    .company-info p {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .invoice-meta {
      text-align: right;
    }

    .invoice-meta h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .meta-row {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      font-size: 13px;
      margin-bottom: 6px;
    }

    .meta-row strong {
      min-width: 80px;
      text-align: right;
      font-weight: 500;
    }

    .invoice-table {
      margin: 24px 0;
    }

    .invoice-table input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
    }

    .totals-section {
      display: flex;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .totals-table {
      width: 350px;
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      font-size: 14px;
    }

    .totals-row.total {
      border-top: 2px solid var(--brand-primary);
      margin-top: 12px;
      padding-top: 12px;
      font-size: 18px;
      font-weight: 700;
      color: var(--brand-primary);
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--brand-light);
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .empty-state p {
      color: var(--text-muted);
      font-size: 14px;
    }

    /* PRINT STYLES */
    @media print {
      @page {
        margin: 0.75in;
        size: letter;
      }

      /* Force colors to print */
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }

      /* Reset body */
      body {
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      /* Hide EVERYTHING first */
      body * {
        visibility: hidden;
      }

      /* Then show only invoice area and its children */
      #invoicePreviewArea,
      #invoicePreviewArea * {
        visibility: visible;
      }

      /* Position invoice at top of page */
      #invoicePreviewArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        background: white !important;
        padding: 0 !important;
        margin: 0 !important;
        border: none !important;
        box-shadow: none !important;
      }

      /* Hide buttons in invoice */
      #invoicePreviewArea button,
      #invoicePreviewArea .btn {
        display: none !important;
        visibility: hidden !important;
      }

      /* Ensure text is visible and black */
      #invoicePreviewArea,
      #invoicePreviewArea * {
        color: #000 !important;
      }

      /* Table styling for print */
      table {
        border-collapse: collapse;
        width: 100%;
        page-break-inside: auto;
      }

      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }

      thead {
        display: table-header-group;
      }

      th, td {
        padding: 8px;
        border: 1px solid #ddd;
      }
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: flex;
      }

      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
        box-shadow: none;
      }

      .sidebar.mobile-open {
        transform: translateX(0);
        box-shadow: 10px 0 30px rgba(0, 0, 0, 0.3);
      }

      /* Mobile backdrop */
      .sidebar.mobile-open::after {
        content: "";
        position: fixed;
        top: 0;
        left: var(--sidebar-width);
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: -1;
      }

      .main-content {
        margin-left: 0;
      }

      .content-area {
        padding: 20px 16px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .top-bar {
        padding: 12px 16px;
      }

      .search-bar {
        flex: 1;
        max-width: 100%;
      }

      .top-actions {
        gap: 8px;
      }

      /* Better table scrolling on mobile */
      .table-container {
        overflow-x: auto;
      }

      table {
        min-width: 800px;
      }

      th, td {
        white-space: nowrap;
        font-size: 13px;
        padding: 12px 16px;
      }

      /* Stack filters on mobile */
      .filters {
        grid-template-columns: 1fr;
      }

      /* Invoice preview on mobile */
      .invoice-preview {
        padding: 20px 16px;
      }

      .invoice-header-section {
        flex-direction: column;
        gap: 20px;
      }

      .invoice-meta {
        text-align: left;
      }

      /* Modal improvements */
      .modal-content {
        margin: 20px;
        max-height: 85vh;
      }

      .modal-body {
        padding: 20px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      /* Make buttons thumb-friendly */
      .btn, .icon-btn {
        min-height: 44px;
        min-width: 44px;
      }
    }

    /* Extra small phones */
    @media (max-width: 400px) {
      .page-title {
        font-size: 24px;
      }

      .stat-value {
        font-size: 28px;
      }

      .company-info h2 {
        font-size: 20px;
      }
    }

    @media print {
      .sidebar,
      .top-bar,
      .table-actions,
      .modal-footer {
        display: none !important;
      }

      .main-content {
        margin-left: 0;
      }

      .invoice-preview {
        box-shadow: none;
        border: none;
      }
    }
  </style>
</head>
<body>
  <!-- ADMIN LOGIN SCREEN -->
  <div id="adminLoginScreen" class="admin-login-screen">
    <div class="login-container">
      <div class="login-logo">B5</div>
      <h1>Admin Portal</h1>
      <p class="subtitle">Enter your credentials to access the admin dashboard</p>
      
      <div class="form-group" style="text-align: left; margin-bottom: 16px;">
        <label class="form-label">Username</label>
        <input 
          type="text" 
          id="adminUsername" 
          class="form-input" 
          placeholder="Enter username"
          autocomplete="username"
        />
      </div>

      <div class="form-group" style="text-align: left; margin-bottom: 24px;">
        <label class="form-label">Password</label>
        <input 
          type="password" 
          id="adminPassword" 
          class="form-input" 
          placeholder="Enter password"
          autocomplete="current-password"
        />
      </div>
      
      <button class="btn btn-primary" onclick="adminLogin()" style="width: 100%;">Sign In</button>
      
      <div id="adminErrorMsg" class="error-msg">
        ⚠️ Invalid credentials. Please try again.
      </div>

      <div class="admin-link">
        <a href="driver-portal.html">← Driver Login</a>
      </div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon">B5</div>
      <div class="logo-text">B5 Trucking</div>
    </div>

    <div class="user-profile">
      <div class="user-avatar">AD</div>
      <div class="user-info">
        <div class="user-name">Admin User</div>
        <div class="user-role">Administrator</div>
      </div>
    </div>

    <nav class="nav-menu">
      <div class="nav-item active" onclick="showSection('dashboard')">
        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
        </svg>
        Dashboard
      </div>

      <div class="nav-item" onclick="showSection('tickets')">
        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Tickets
      </div>

      <div class="nav-item" onclick="showSection('invoices')">
        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z"></path>
        </svg>
        Invoices
      </div>

      <div class="nav-item" onclick="showSection('payroll')">
        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Payroll
      </div>

      <div class="nav-item" onclick="showSection('drivers')">
        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
        </svg>
        Drivers
      </div>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <!-- TOP BAR -->
    <div class="top-bar">
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
      <div class="search-bar">
        <input type="text" class="search-input" placeholder="Search tickets, invoices, drivers...">
      </div>
      <div class="top-actions">
        <button class="icon-btn">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
          </svg>
        </button>
        <button class="icon-btn" onclick="logout()">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- CONTENT AREA -->
    <div class="content-area">
      <!-- DASHBOARD SECTION -->
      <section id="dashboard" class="section active">
        <div class="page-header">
          <h1 class="page-title">Dashboard</h1>
          <p class="page-subtitle">Overview of your trucking operations</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card gradient-1">
            <div class="stat-content">
              <div class="stat-header">
                <div class="stat-label">This Week's Tickets</div>
                <div class="stat-icon">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
              </div>
              <div class="stat-value" id="weeklyTicketsCount">24</div>
              <div class="stat-change positive">
                ↑ 12% from last week
              </div>
            </div>
          </div>

          <div class="stat-card gradient-2">
            <div class="stat-content">
              <div class="stat-header">
                <div class="stat-label">Weekly Revenue</div>
                <div class="stat-icon">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
              </div>
              <div class="stat-value" id="weeklyRevenue">$12,000</div>
              <div class="stat-change positive">
                ↑ 15% from last week
              </div>
            </div>
          </div>

          <div class="stat-card gradient-3">
            <div class="stat-content">
              <div class="stat-header">
                <div class="stat-label">Monthly Revenue</div>
                <div class="stat-icon">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                  </svg>
                </div>
              </div>
              <div class="stat-value" id="monthlyRevenue">$48,500</div>
              <div class="stat-change positive">
                ↑ 8% from last month
              </div>
            </div>
          </div>

          <div class="stat-card gradient-4">
            <div class="stat-content">
              <div class="stat-header">
                <div class="stat-label">Avg Revenue/Ticket</div>
                <div class="stat-icon">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                  </svg>
                </div>
              </div>
              <div class="stat-value" id="avgRevenue">$500</div>
              <div class="stat-change">
                Per ticket average
              </div>
            </div>
          </div>
        </div>

        <div class="table-container">
          <div class="table-header">
            <h2 class="table-title">Revenue Analytics</h2>
          </div>
          
          <div class="filters">
            <div class="filter-group">
              <label class="filter-label">Driver</label>
              <select class="filter-select" id="chartFilterDriver" onchange="updateRevenueChart()">
                <option value="all">All Drivers</option>
                <option value="Bridger Booth">Bridger Booth</option>
                <option value="Tristan Booth">Tristan Booth</option>
                <option value="Tarrell Thomas">Tarrell Thomas</option>
                <option value="Jelani Graham">Jelani Graham</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label class="filter-label">Year</label>
              <select class="filter-select" id="chartFilterYear" onchange="updateRevenueChart()">
                <option value="2025">2025 (This Year)</option>
                <option value="2024">2024 (Last Year)</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label class="filter-label">Time Period</label>
              <select class="filter-select" id="chartFilterView" onchange="handleViewChange()">
                <option value="monthly">Monthly (Full Year)</option>
                <option value="weekly">Weekly (Last 8 Weeks)</option>
                <option value="quarter">Quarterly</option>
              </select>
            </div>

            <div class="filter-group" id="monthFilterGroup">
              <label class="filter-label">Specific Month</label>
              <select class="filter-select" id="chartFilterMonth" onchange="updateRevenueChart()">
                <option value="all">All Months</option>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
              </select>
            </div>
          </div>

          <div style="padding: 32px 24px;">
            <canvas id="revenueChart" style="max-height: 400px;"></canvas>
          </div>

          <!-- Summary Stats Below Chart -->
          <div style="padding: 0 24px 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 16px;">
              <div style="font-size: 12px; color: #92400e; font-weight: 600; margin-bottom: 6px;">TOTAL REVENUE</div>
              <div style="font-size: 24px; font-weight: 700; color: #78350f;" id="chartTotalRevenue">$48,500</div>
            </div>
            <div style="background: #dbeafe; border: 1px solid #bfdbfe; border-radius: 12px; padding: 16px;">
              <div style="font-size: 12px; color: #1e40af; font-weight: 600; margin-bottom: 6px;">TOTAL TICKETS</div>
              <div style="font-size: 24px; font-weight: 700; color: #1e3a8a;" id="chartTotalTickets">97</div>
            </div>
            <div style="background: #d1fae5; border: 1px solid #a7f3d0; border-radius: 12px; padding: 16px;">
              <div style="font-size: 12px; color: #065f46; font-weight: 600; margin-bottom: 6px;">AVG PER TICKET</div>
              <div style="font-size: 24px; font-weight: 700; color: #064e3b;" id="chartAvgPerTicket">$500</div>
            </div>
          </div>
        </div>
      </section>

      <!-- PAYROLL SECTION -->
      <section id="payroll" class="section">
        <div class="page-header">
          <h1 class="page-title">Payroll</h1>
          <p class="page-subtitle">Manage driver payments</p>
        </div>

        <!-- Payroll Generator -->
        <div class="form-card">
          <h2 class="card-title">Generate Payroll</h2>
          
          <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <svg width="20" height="20" fill="#3b82f6" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
              <span style="font-weight: 600; color: #1e40af;">Suggested Pay Period (2 weeks behind)</span>
            </div>
            <div style="color: #1e3a8a; font-size: 14px; margin-bottom: 12px;" id="suggestedPeriod">Dec 9-15, 2025</div>
            <button class="btn btn-secondary" onclick="useSuggestedDates()" style="background: #3b82f6; color: white; border-color: #2563eb;">
              Use Suggested Dates
            </button>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-input" id="payrollStartDate">
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" class="form-input" id="payrollEndDate">
            </div>
            <div class="form-group" style="display: flex; align-items: flex-end;">
              <button class="btn btn-primary" onclick="generatePayroll()" style="width: 100%; height: 44px;">
                Generate Payroll
              </button>
            </div>
          </div>
        </div>

        <!-- Payroll Preview -->
        <div id="payrollPreviewArea" style="display: none;">
          <div class="form-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div>
                <h2 class="card-title" style="margin: 0;">Payroll Preview</h2>
                <p style="color: var(--text-muted); font-size: 14px; margin: 4px 0 0 0;">Period: <span id="payrollPeriodDisplay"></span></p>
              </div>
            </div>

            <div style="overflow-x: auto; margin-bottom: 20px;">
              <table>
                <thead>
                  <tr>
                    <th style="width: 50px;">Pay?</th>
                    <th>Driver Name</th>
                    <th style="text-align: center;">Loads</th>
                    <th style="text-align: right;">Base Pay</th>
                    <th style="text-align: right;">Bonus</th>
                    <th style="text-align: right;">Total Pay</th>
                    <th style="width: 100px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="payrollTableBody">
                </tbody>
                <tfoot style="background: #fafafa; font-weight: 600;">
                  <tr>
                    <td></td>
                    <td>TOTAL</td>
                    <td style="text-align: center;" id="payrollTotalLoads">0</td>
                    <td style="text-align: right;" id="payrollTotalBase">$0.00</td>
                    <td style="text-align: right;" id="payrollTotalBonus">$0.00</td>
                    <td style="text-align: right; color: var(--brand-primary);" id="payrollGrandTotal">$0.00</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="form-group">
              <label class="form-label">Notes (optional)</label>
              <textarea class="form-input" id="payrollNotes" rows="2" placeholder="e.g., Week of 12/9 - Holiday bonus included"></textarea>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
              <button class="btn btn-secondary" onclick="cancelPayroll()">Cancel</button>
              <button class="btn btn-primary" onclick="savePayroll()">Mark Selected as Paid</button>
            </div>
          </div>
        </div>

        <!-- Payroll History -->
        <div class="table-container" style="margin-top: 32px;">
          <div class="table-header">
            <h2 class="table-title">Payroll History</h2>
          </div>
          <table>
            <thead>
              <tr>
                <th>Period</th>
                <th>Paid On</th>
                <th style="text-align: center;">Drivers</th>
                <th style="text-align: right;">Total Paid</th>
                <th style="text-align: center;">Actions</th>
              </tr>
            </thead>
            <tbody id="payrollHistoryTable">
              <tr>
                <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">No payroll records yet</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- TICKETS SECTION -->
      <section id="tickets" class="section">
        <div class="page-header">
          <h1 class="page-title">All Tickets</h1>
          <p class="page-subtitle">View and manage all driver tickets</p>
        </div>

        <div class="table-container">
          <div class="filters">
            <div class="filter-group">
              <label class="filter-label">Driver</label>
              <select class="filter-select" id="filterDriver">
                <option value="">All Drivers</option>
                <option value="Bridger Booth">Bridger Booth</option>
                <option value="Tristan Booth">Tristan Booth</option>
                <option value="Tarrell Thomas">Tarrell Thomas</option>
                <option value="Jelani Graham">Jelani Graham</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Start Date</label>
              <input type="date" class="filter-input" id="filterStartDate">
            </div>
            <div class="filter-group">
              <label class="filter-label">End Date</label>
              <input type="date" class="filter-input" id="filterEndDate">
            </div>
            <div class="filter-group">
              <label class="filter-label">Truck</label>
              <select class="filter-select" id="filterTruck">
                <option value="">All Trucks</option>
                <option value="Truck 1">Truck 1</option>
                <option value="Truck 2">Truck 2</option>
                <option value="Truck 3">Truck 3</option>
                <option value="Truck 4">Truck 4</option>
                <option value="Truck 5">Truck 5</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label" style="opacity: 0;">Load</label>
              <button class="btn btn-primary" onclick="applyTicketFilters()" style="width: 100%; height: 44px;">Load Tickets</button>
            </div>
          </div>

          <div class="table-header">
            <h2 class="table-title">Ticket Records</h2>
            <div class="table-actions">
              <button class="btn btn-secondary" onclick="exportTicketsCSV()">Export CSV</button>
              <button class="btn btn-secondary" onclick="exportTicketsExcel()">Export Excel</button>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Driver</th>
                <th>Truck</th>
                <th>Ticket #</th>
                <th>Gross (lbs)</th>
                <th>Tare (lbs)</th>
                <th>Net Tons</th>
                <th>3rd Load</th>
                <th>Pay</th>
                <th>Photo</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="allTicketsTable">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- INVOICES SECTION -->
      <section id="invoices" class="section">
        <div class="page-header">
          <h1 class="page-title">Invoices</h1>
          <p class="page-subtitle">Create and manage invoices</p>
        </div>

        <div class="table-container" style="margin-bottom: 24px;">
          <div class="table-header">
            <h2 class="table-title">Create New Invoice</h2>
          </div>
          <div class="modal-body">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-input" id="invoiceStartDate">
              </div>
              <div class="form-group">
                <label class="form-label">End Date</label>
                <input type="date" class="form-input" id="invoiceEndDate">
              </div>
              <div class="form-group">
                <label class="form-label">Fuel Base ($)</label>
                <input type="number" class="form-input" id="fuelBase" value="3.50" step="0.01">
                <span class="form-helper">Contract baseline per gallon</span>
              </div>
              <div class="form-group">
                <label class="form-label">Current Fuel Rate ($)</label>
                <input type="number" class="form-input" id="fuelRate" value="4.25" step="0.01">
                <span class="form-helper">Current pump price per gallon</span>
              </div>
            </div>
            <button class="btn btn-primary" onclick="generateInvoicePreview()">
              Generate Invoice Preview
            </button>
          </div>
        </div>

        <!-- Invoice Preview Area -->
        <div id="invoicePreviewArea" style="display: none;">
          <div class="invoice-preview">
            <div class="invoice-header-section">
              <div class="company-info">
                <h2>B5 Trucking</h2>
                <p>Bridger Booth<br>
                196 E 1000 S, Bountiful, UT 84010<br>
                B5linehaul@gmail.com · 801-721-1713</p>
              </div>
              <div class="invoice-meta">
                <h3>Invoice</h3>
                <div class="meta-row">
                  <strong>Invoice #</strong>
                  <span id="invoiceNumber">1001</span>
                </div>
                <div class="meta-row">
                  <strong>Date</strong>
                  <span id="invoiceDate">12/25/2025</span>
                </div>
                <div class="meta-row">
                  <strong>Period</strong>
                  <span id="invoicePeriod">-</span>
                </div>
              </div>
            </div>

            <div style="margin-bottom: 24px;">
              <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Bill To</h4>
              <p style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">
                Robinson Waste Services, Inc.<br>
                2719 N Fairfield Rd<br>
                Layton, UT 84041
              </p>
            </div>

            <table class="invoice-table">
              <thead>
                <tr>
                  <th>Ticket #</th>
                  <th>Date</th>
                  <th>Truck #</th>
                  <th style="text-align: center;">Qty</th>
                  <th style="text-align: right;">Net Tons</th>
                  <th style="text-align: right;">Total</th>
                </tr>
              </thead>
              <tbody id="invoiceTicketsBody">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>

            <div class="totals-section">
              <div class="totals-table">
                <div class="totals-row">
                  <strong>Subtotal</strong>
                  <span id="invoiceSubtotal">$0.00</span>
                </div>
                <div id="fuelSurchargeSection" style="display: none;">
                  <div class="totals-row" style="color: var(--brand-primary); font-weight: 600; margin-top: 12px;">
                    <strong>Fuel Surcharge</strong>
                    <span id="fuelSurchargeTotal">$0.00</span>
                  </div>
                  <div style="font-size: 12px; color: var(--text-muted); margin: 4px 0;">
                    <div id="fuelSurchargeCalc"></div>
                  </div>
                </div>
                <div class="totals-row total">
                  <strong>Total Due</strong>
                  <span id="invoiceGrandTotal">$0.00</span>
                </div>
              </div>
            </div>

            <div style="margin-top: 32px; padding-top: 16px; border-top: 1px dashed var(--border); font-size: 12px; color: var(--text-muted);">
              <strong>Payment Terms:</strong> Net 15 days.<br>
              <strong>Notes:</strong> Thank you for your business. Please remit payment within 15 days of the invoice date.
            </div>

            <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
              <button class="btn btn-secondary" onclick="window.print()">Print Invoice</button>
              <button class="btn btn-primary" onclick="saveInvoice()">Save & Download PDF</button>
            </div>
          </div>
        </div>

        <!-- Previous Invoices -->
        <div class="table-container" style="margin-top: 32px;">
          <div class="table-header">
            <h2 class="table-title">Previous Invoices</h2>
            <div class="table-actions">
              <input type="text" placeholder="Search invoices..." style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Date Created</th>
                <th>Period</th>
                <th>Tickets</th>
                <th>Amount</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="previousInvoicesTable">
              <tr>
                <td>1000</td>
                <td>12/18/2025</td>
                <td>12/11 - 12/17</td>
                <td>18</td>
                <td>$9,450.00</td>
                <td>
                  <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">View PDF</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- PAYROLL SECTION -->
      <section id="payroll" class="section">
        <div class="page-header">
          <h1 class="page-title">Payroll</h1>
          <p class="page-subtitle">Generate and manage driver payroll</p>
        </div>

        <!-- Payroll Generator -->
        <div class="form-card">
          <h2 class="card-title">Generate Payroll</h2>
          
          <div style="background: #e0f2fe; border: 1px solid #bae6fd; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <svg width="20" height="20" fill="none" stroke="#0369a1" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <strong style="color: #0369a1;">Suggested Pay Period (2 weeks behind)</strong>
            </div>
            <p style="color: #075985; font-size: 14px; margin: 0 0 12px 32px;" id="suggestedPeriod">Loading...</p>
            <button class="btn btn-secondary" onclick="useSuggestedDates()" style="margin-left: 32px; background: white; border-color: #0369a1; color: #0369a1;">
              Use Suggested Dates
            </button>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; align-items: end;">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-input" id="payrollStartDate">
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" class="form-input" id="payrollEndDate">
            </div>
            <button class="btn btn-primary" onclick="generatePayroll()" style="height: 44px;">
              Generate Payroll
            </button>
          </div>
        </div>

        <!-- Payroll Preview -->
        <div id="payrollPreviewArea" style="display: none;">
          <div class="form-card">
            <h2 class="card-title">Payroll Preview</h2>
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">
              Period: <strong id="payrollPeriodDisplay">-</strong>
            </p>

            <div style="overflow-x: auto; margin-bottom: 24px;">
              <table>
                <thead>
                  <tr>
                    <th style="width: 50px; text-align: center;">Pay?</th>
                    <th>Driver Name</th>
                    <th style="text-align: center;">Loads</th>
                    <th style="text-align: right;">Base Pay</th>
                    <th style="text-align: right;">Bonus</th>
                    <th style="text-align: right;">Total</th>
                    <th style="text-align: center;">Actions</th>
                  </tr>
                </thead>
                <tbody id="payrollTableBody">
                  <!-- Populated by JavaScript -->
                </tbody>
                <tfoot>
                  <tr style="font-weight: 700; background: #fafafa;">
                    <td></td>
                    <td>TOTAL</td>
                    <td style="text-align: center;" id="payrollTotalLoads">0</td>
                    <td style="text-align: right;" id="payrollTotalBase">$0.00</td>
                    <td style="text-align: right;" id="payrollTotalBonus">$0.00</td>
                    <td style="text-align: right; color: var(--brand-primary);" id="payrollGrandTotal">$0.00</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="form-group">
              <label class="form-label">Notes (optional)</label>
              <textarea class="form-input" id="payrollNotes" rows="2" placeholder="e.g., Week of 12/9 - Holiday bonus included"></textarea>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
              <button class="btn btn-secondary" onclick="document.getElementById('payrollPreviewArea').style.display='none'">Cancel</button>
              <button class="btn btn-primary" onclick="markAsPaid()">Mark Selected as Paid</button>
            </div>
          </div>
        </div>

        <!-- Payroll History -->
        <div class="table-container" style="margin-top: 32px;">
          <div class="table-header">
            <h2 class="table-title">Payroll History</h2>
          </div>
          <table>
            <thead>
              <tr>
                <th>Pay Period</th>
                <th>Paid On</th>
                <th style="text-align: center;">Drivers</th>
                <th style="text-align: right;">Total Paid</th>
                <th>Notes</th>
                <th style="text-align: center;">Actions</th>
              </tr>
            </thead>
            <tbody id="payrollHistoryTable">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">No payroll records yet</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- DRIVERS SECTION -->
      <section id="drivers" class="section">
        <div class="page-header">
          <h1 class="page-title">Drivers</h1>
          <p class="page-subtitle">Manage driver accounts and codes</p>
        </div>

        <div class="table-container">
          <div class="table-header">
            <h2 class="table-title">Active Drivers</h2>
            <div class="table-actions">
              <button class="btn btn-primary" onclick="openAddDriverModal()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add Driver
              </button>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Driver Code</th>
                <th>Driver Name</th>
                <th>Date Added</th>
                <th>Total Tickets</th>
                <th>Total Pay (All Time)</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="driversTable">
              <tr>
                <td><span class="badge info">13</span></td>
                <td>Bridger Booth</td>
                <td>11/15/2025</td>
                <td>142</td>
                <td>$18,720.00</td>
                <td><span class="badge success">Active</span></td>
                <td>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editDriver('13', 'Bridger Booth', 'active')">Edit</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #fef3c7; border-color: #fde68a;" onclick="toggleDriverStatus('13', 'Bridger Booth', 'active')">Deactivate</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #fee2e2; border-color: #fecaca; color: #991b1b;" onclick="deleteDriver('13', 'Bridger Booth')">Delete</button>
                  </div>
                </td>
              </tr>
              <tr>
                <td><span class="badge info">17</span></td>
                <td>Tristan Booth</td>
                <td>11/15/2025</td>
                <td>138</td>
                <td>$17,940.00</td>
                <td><span class="badge success">Active</span></td>
                <td>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editDriver('17', 'Tristan Booth', 'active')">Edit</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #fef3c7; border-color: #fde68a;" onclick="toggleDriverStatus('17', 'Tristan Booth', 'active')">Deactivate</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #fee2e2; border-color: #fecaca; color: #991b1b;" onclick="deleteDriver('17', 'Tristan Booth')">Delete</button>
                  </div>
                </td>
              </tr>
              <tr>
                <td><span class="badge info">01</span></td>
                <td>Tarrell Thomas</td>
                <td>11/20/2025</td>
                <td>95</td>
                <td>$12,480.00</td>
                <td><span class="badge success">Active</span></td>
                <td>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editDriver('01', 'Tarrell Thomas', 'active')">Edit</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #fef3c7; border-color: #fde68a;" onclick="toggleDriverStatus('01', 'Tarrell Thomas', 'active')">Deactivate</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #fee2e2; border-color: #fecaca; color: #991b1b;" onclick="deleteDriver('01', 'Tarrell Thomas')">Delete</button>
                  </div>
                </td>
              </tr>
              <tr>
                <td><span class="badge info">02</span></td>
                <td>Jelani Graham</td>
                <td>11/22/2025</td>
                <td>87</td>
                <td>$11,310.00</td>
                <td><span class="badge success">Active</span></td>
                <td>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editDriver('02', 'Jelani Graham', 'active')">Edit</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #fef3c7; border-color: #fde68a;" onclick="toggleDriverStatus('02', 'Jelani Graham', 'active')">Deactivate</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #fee2e2; border-color: #fecaca; color: #991b1b;" onclick="deleteDriver('02', 'Jelani Graham')">Delete</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <!-- ADD DRIVER MODAL -->
  <div id="addDriverModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add New Driver</h2>
        <button class="modal-close" onclick="closeAddDriverModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-input" id="newDriverName" placeholder="First Last">
          </div>
          <div class="form-group">
            <label class="form-label">Driver Code (2 digits)</label>
            <input type="text" class="form-input" id="newDriverCode" maxlength="2" placeholder="00">
            <span class="form-helper">Unique 2-digit code for driver login</span>
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="newDriverStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddDriverModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveDriver()">Add Driver</button>
      </div>
    </div>
  </div>

  <!-- EDIT DRIVER MODAL -->
  <div id="editDriverModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Driver</h2>
        <button class="modal-close" onclick="closeEditDriverModal()">×</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editDriverOriginalCode">
        <div class="form-grid">
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-input" id="editDriverName" placeholder="First Last">
          </div>
          <div class="form-group">
            <label class="form-label">Driver Code (2 digits)</label>
            <input type="text" class="form-input" id="editDriverCode" maxlength="2" placeholder="00">
            <span class="form-helper">Unique 2-digit code for driver login</span>
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="editDriverStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditDriverModal()">Cancel</button>
        <button class="btn btn-primary" onclick="updateDriver()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- DELETE CONFIRMATION MODAL -->
  <div id="deleteDriverModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title" style="color: #dc2626;">⚠️ Delete Driver</h2>
        <button class="modal-close" onclick="closeDeleteDriverModal()">×</button>
      </div>
      <div class="modal-body">
        <div style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <p style="font-weight: 600; color: #991b1b; margin-bottom: 8px;">⚠️ WARNING: This action cannot be undone!</p>
          <p style="font-size: 14px; color: #7f1d1d; margin: 0;">Deleting this driver will permanently remove:</p>
          <ul style="font-size: 14px; color: #7f1d1d; margin: 8px 0 0 20px; padding: 0;">
            <li>All ticket records</li>
            <li>All payment history</li>
            <li>All uploaded photos</li>
            <li>Driver login access</li>
          </ul>
        </div>
        
        <p style="font-size: 14px; margin-bottom: 20px;">
          You are about to delete: <strong id="deleteDriverName" style="color: #dc2626;"></strong> (Code: <strong id="deleteDriverCode" style="color: #dc2626;"></strong>)
        </p>
        
        <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <p style="font-weight: 600; color: #92400e; margin-bottom: 8px;">💡 Alternative: Deactivate Instead</p>
          <p style="font-size: 13px; color: #78350f; margin: 0;">Consider deactivating this driver to preserve their data while preventing new logins.</p>
        </div>

        <div class="form-group">
          <label class="form-label" style="color: #dc2626;">Type "DELETE" to confirm</label>
          <input type="text" class="form-input" id="deleteConfirmText" placeholder="Type DELETE in all caps" style="border-color: #fecaca;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDeleteDriverModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmDeleteDriver()" style="background: #dc2626;" id="confirmDeleteBtn" disabled>Delete Driver</button>
      </div>
    </div>
  </div>

  <!-- EDIT TICKET MODAL -->
  <div id="editTicketModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Ticket</h2>
        <button class="modal-close" onclick="closeEditTicketModal()">×</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editTicketId">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Driver</label>
            <input type="text" class="form-input" id="editTicketDriver" readonly style="background: #f3f4f6;">
          </div>
          <div class="form-group">
            <label class="form-label">Ticket Date</label>
            <input type="date" class="form-input" id="editTicketDate">
          </div>
          <div class="form-group">
            <label class="form-label">Ticket Number</label>
            <input type="text" class="form-input" id="editTicketNumber">
          </div>
          <div class="form-group">
            <label class="form-label">Truck Number</label>
            <select class="form-select" id="editTicketTruck">
              <option value="Truck 1">Truck 1</option>
              <option value="Truck 2">Truck 2</option>
              <option value="Truck 3">Truck 3</option>
              <option value="Truck 4">Truck 4</option>
              <option value="Truck 5">Truck 5</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Gross Weight (lbs)</label>
            <input type="number" class="form-input" id="editTicketGross">
          </div>
          <div class="form-group">
            <label class="form-label">Tare Weight (lbs)</label>
            <input type="number" class="form-input" id="editTicketTare">
          </div>
          <div class="form-group">
            <label class="form-label">Net Tons (auto-calculated)</label>
            <input type="text" class="form-input" id="editTicketNetTons" readonly style="background: #f3f4f6;">
          </div>
          <div class="form-group">
            <label class="form-label">3rd Load Bonus</label>
            <select class="form-select" id="editTicketThirdLoad">
              <option value="false">No</option>
              <option value="true">Yes (+$10)</option>
            </select>
          </div>
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">Route Notes</label>
            <textarea class="form-input" id="editTicketNotes" rows="3"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditTicketModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveTicketEdits()">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://jnytbgbevfyfqpjsdwiv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpueXRiZ2JldmZ5ZnFwanNkd2l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2ODQ5NzAsImV4cCI6MjA4MjI2MDk3MH0.3MNnntapdLT7TLAjwftHVQQ8Wir75OlAQ8wteifhiUM';
    
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let allTickets = [];
    let allDrivers = [];

    // Admin Login
    async function adminLogin() {
      const username = document.getElementById('adminUsername').value;
      const password = document.getElementById('adminPassword').value;

      // Simple validation - TODO: Add proper Supabase authentication later
      if (username === 'Bridger' && password === 'Gandalf17') {
        try {
          // Save admin session
          localStorage.setItem('b5_admin_session', JSON.stringify({
            username: username,
            loginTime: new Date().toISOString()
          }));

          // Load initial data
          await loadAllData();

          // Hide login screen
          document.getElementById('adminLoginScreen').classList.add('hidden');
          
          // Show sidebar and main content
          document.querySelector('.sidebar').classList.add('show');
          document.querySelector('.main-content').classList.add('show');
          
          // Initialize chart
          setTimeout(() => {
            if (typeof initializeRevenueChart === 'function') {
              initializeRevenueChart();
              // Update with real data
              if (typeof updateRevenueChart === 'function') {
                updateRevenueChart();
              }
            }
          }, 100);

          // Initialize payroll
          updateSuggestedDates();
          loadPayrollHistory();

        } catch (err) {
          console.error('Error loading data:', err);
          alert('Error loading data. Please try again.');
        }
      } else {
        const errorMsg = document.getElementById('adminErrorMsg');
        errorMsg.style.display = 'block';
        setTimeout(() => {
          errorMsg.style.display = 'none';
        }, 3000);
      }
    }

    // Load all data from Supabase
    async function loadAllData() {
      try {
        // Load all tickets
        const { data: tickets, error: ticketsError } = await supabaseClient
          .from('tickets')
          .select('*')
          .order('created_at', { ascending: false });

        if (ticketsError) throw ticketsError;
        allTickets = tickets || [];

        // Load all drivers
        const { data: drivers, error: driversError } = await supabaseClient
          .from('drivers')
          .select('*')
          .order('name', { ascending: true });

        if (driversError) throw driversError;
        allDrivers = drivers || [];

        // Update dashboard stats
        updateDashboardStats();

        // Populate drivers table
        populateDriversTable();

        // Populate driver filter dropdown
        populateDriverFilter();

        // Don't auto-load tickets - wait for user to click Load button

        // Load invoices list
        loadInvoicesList();

        // Initialize payroll
        updateSuggestedPeriod();
        loadPayrollHistory();

      } catch (err) {
        console.error('Error loading data:', err);
        throw err;
      }
    }

    // Populate driver filter dropdown
    function populateDriverFilter() {
      const filterDriver = document.getElementById('filterDriver');
      const chartFilterDriver = document.getElementById('chartFilterDriver');
      
      const driverOptions = allDrivers.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
      
      // Populate tickets filter
      if (filterDriver) {
        filterDriver.innerHTML = '<option value="">All Drivers</option>' + driverOptions;
      }
      
      // Populate chart filter
      if (chartFilterDriver) {
        chartFilterDriver.innerHTML = '<option value="all">All Drivers</option>' + driverOptions;
      }
    }

    // Update dashboard statistics
    function updateDashboardStats() {
      // Get current week tickets
      const now = new Date();
      const dayOfWeek = now.getDay();
      const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      const monday = new Date(now);
      monday.setDate(now.getDate() + daysToMonday);
      monday.setHours(0, 0, 0, 0);

      const weekTickets = allTickets.filter(t => {
        const ticketDate = new Date(t.ticket_date);
        return ticketDate >= monday;
      });

      // Get current month tickets
      const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const monthTickets = allTickets.filter(t => {
        const ticketDate = new Date(t.ticket_date);
        return ticketDate >= firstOfMonth;
      });

      // Calculate totals
      const weekRevenue = weekTickets.reduce((sum, t) => sum + (t.driver_pay + t.bonus_pay), 0) * (500/130); // Scale up to client rate
      const monthRevenue = monthTickets.reduce((sum, t) => sum + (t.driver_pay + t.bonus_pay), 0) * (500/130);

      // Update stat cards
      document.getElementById('weeklyTicketsCount').textContent = weekTickets.length;
      document.getElementById('weeklyRevenue').textContent = '$' + weekRevenue.toLocaleString();
      document.getElementById('monthlyRevenue').textContent = '$' + monthRevenue.toLocaleString();
      
      const avgRevenue = allTickets.length > 0 ? (500) : 0;
      document.getElementById('avgRevenue').textContent = '$' + avgRevenue;
    }

    // Populate tickets table with filters
    function populateTicketsTable(filteredTickets = null) {
      const tickets = filteredTickets || allTickets;
      const tbody = document.getElementById('allTicketsTable');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (tickets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: var(--text-muted);">No tickets found</td></tr>';
        return;
      }

      tickets.forEach(ticket => {
        const row = tbody.insertRow();
        
        // Fix timezone issue
        const ticketDate = ticket.ticket_date;
        const displayDate = new Date(ticketDate + 'T00:00:00').toLocaleDateString();
        
        row.innerHTML = `
          <td>${displayDate}</td>
          <td>${ticket.driver_name}</td>
          <td>${ticket.truck_number}</td>
          <td>${ticket.ticket_number}</td>
          <td>${ticket.gross_weight.toLocaleString()}</td>
          <td>${ticket.tare_weight.toLocaleString()}</td>
          <td>${ticket.net_tons.toFixed(2)}</td>
          <td>${ticket.third_load ? '<span class="badge success">Yes</span>' : '-'}</td>
          <td>$${(ticket.driver_pay + ticket.bonus_pay).toFixed(2)}</td>
          <td>
            ${ticket.photo_url && ticket.photo_url !== 'pending' 
              ? `<a href="${ticket.photo_url}" target="_blank" class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;">View</a>` 
              : '<span style="color: var(--text-muted); font-size: 11px;">Pending</span>'}
          </td>
          <td>
            <div style="display: flex; gap: 6px;">
              <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 11px; background: #e0f2fe; border-color: #bae6fd; color: #0369a1;" onclick='openEditTicketModal(${JSON.stringify(ticket)})'>Edit</button>
              <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 11px; background: #fee2e2; border-color: #fecaca; color: #991b1b;" onclick="deleteTicket('${ticket.id}', '${ticket.ticket_number}', '${ticket.driver_name}')">Delete</button>
            </div>
          </td>
        `;
      });
    }

    // Apply ticket filters
    function applyTicketFilters() {
      const filterDriver = document.getElementById('filterDriver').value;
      const filterStartDate = document.getElementById('filterStartDate').value;
      const filterEndDate = document.getElementById('filterEndDate').value;
      const filterTruck = document.getElementById('filterTruck').value;

      let filtered = [...allTickets];

      // Filter by driver
      if (filterDriver) {
        filtered = filtered.filter(t => t.driver_name === filterDriver);
      }

      // Filter by start date
      if (filterStartDate) {
        filtered = filtered.filter(t => {
          const ticketDate = new Date(t.ticket_date);
          const startDate = new Date(filterStartDate);
          return ticketDate >= startDate;
        });
      }

      // Filter by end date
      if (filterEndDate) {
        filtered = filtered.filter(t => {
          const ticketDate = new Date(t.ticket_date);
          const endDate = new Date(filterEndDate);
          return ticketDate <= endDate;
        });
      }

      // Filter by truck
      if (filterTruck) {
        filtered = filtered.filter(t => t.truck_number === filterTruck);
      }

      populateTicketsTable(filtered);
    }

    // Export tickets to CSV
    function exportTicketsCSV() {
      if (allTickets.length === 0) {
        alert('No tickets to export');
        return;
      }

      const headers = ['Date', 'Driver', 'Truck', 'Ticket #', 'Gross Weight', 'Tare Weight', 'Net Tons', '3rd Load', 'Pay'];
      const rows = allTickets.map(t => [
        new Date(t.ticket_date).toLocaleDateString(),
        t.driver_name,
        t.truck_number,
        t.ticket_number,
        t.gross_weight,
        t.tare_weight,
        t.net_tons,
        t.third_load ? 'Yes' : 'No',
        (t.driver_pay + t.bonus_pay).toFixed(2)
      ]);

      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `b5-tickets-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Export tickets to Excel (simplified CSV that Excel can open)
    function exportTicketsExcel() {
      exportTicketsCSV(); // For now, same as CSV - Excel opens CSV files fine
    }

    // Delete Ticket
    async function deleteTicket(ticketId, ticketNumber, driverName) {
      if (!confirm(`Are you sure you want to delete ticket #${ticketNumber} from ${driverName}?\n\nThis action cannot be undone.`)) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('tickets')
          .delete()
          .eq('id', ticketId);

        if (error) throw error;

        alert('Ticket deleted successfully!');
        
        // Reload all data to update dashboard, chart, and tables
        await loadAllData();

      } catch (err) {
        console.error('Error deleting ticket:', err);
        alert('Error deleting ticket: ' + err.message);
      }
    }

    // Edit Ticket Modal Functions
    function openEditTicketModal(ticket) {
      document.getElementById('editTicketId').value = ticket.id;
      document.getElementById('editTicketDriver').value = ticket.driver_name;
      document.getElementById('editTicketDate').value = ticket.ticket_date;
      document.getElementById('editTicketNumber').value = ticket.ticket_number;
      document.getElementById('editTicketTruck').value = ticket.truck_number;
      document.getElementById('editTicketGross').value = ticket.gross_weight;
      document.getElementById('editTicketTare').value = ticket.tare_weight;
      document.getElementById('editTicketNetTons').value = ticket.net_tons.toFixed(2);
      document.getElementById('editTicketThirdLoad').value = ticket.third_load.toString();
      document.getElementById('editTicketNotes').value = ticket.route_notes || '';
      
      // Add event listeners to recalculate net tons when weights change
      const grossInput = document.getElementById('editTicketGross');
      const tareInput = document.getElementById('editTicketTare');
      const netTonsInput = document.getElementById('editTicketNetTons');
      
      const recalculate = () => {
        const gross = parseFloat(grossInput.value) || 0;
        const tare = parseFloat(tareInput.value) || 0;
        const netTons = (gross - tare) / 2000;
        netTonsInput.value = netTons.toFixed(2);
      };
      
      grossInput.addEventListener('input', recalculate);
      tareInput.addEventListener('input', recalculate);
      
      document.getElementById('editTicketModal').classList.add('active');
    }

    function closeEditTicketModal() {
      document.getElementById('editTicketModal').classList.remove('active');
    }

    async function saveTicketEdits() {
      const ticketId = document.getElementById('editTicketId').value;
      const ticketDate = document.getElementById('editTicketDate').value;
      const ticketNumber = document.getElementById('editTicketNumber').value;
      const truckNumber = document.getElementById('editTicketTruck').value;
      const grossWeight = parseFloat(document.getElementById('editTicketGross').value);
      const tareWeight = parseFloat(document.getElementById('editTicketTare').value);
      const netTons = (grossWeight - tareWeight) / 2000;
      const thirdLoad = document.getElementById('editTicketThirdLoad').value === 'true';
      const routeNotes = document.getElementById('editTicketNotes').value;

      if (!ticketDate || !ticketNumber || !truckNumber || !grossWeight || !tareWeight) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const bonusPay = thirdLoad ? 10 : 0;

        const { error } = await supabaseClient
          .from('tickets')
          .update({
            ticket_date: ticketDate,
            ticket_number: ticketNumber,
            truck_number: truckNumber,
            gross_weight: grossWeight,
            tare_weight: tareWeight,
            net_tons: netTons,
            third_load: thirdLoad,
            bonus_pay: bonusPay,
            route_notes: routeNotes
          })
          .eq('id', ticketId);

        if (error) throw error;

        alert('Ticket updated successfully!');
        closeEditTicketModal();
        
        // Reload data
        await loadAllData();

      } catch (err) {
        console.error('Error updating ticket:', err);
        alert('Error updating ticket: ' + err.message);
      }
    }

    // Populate drivers table
    function populateDriversTable() {
      const tbody = document.getElementById('driversTable');
      if (!tbody) return;

      tbody.innerHTML = '';

      allDrivers.forEach(driver => {
        // Count tickets and calculate total pay for this driver
        const driverTickets = allTickets.filter(t => t.driver_id === driver.id);
        const totalPay = driverTickets.reduce((sum, t) => sum + t.driver_pay + t.bonus_pay, 0);

        const row = tbody.insertRow();
        row.innerHTML = `
          <td><span class="badge info">${driver.driver_code}</span></td>
          <td>${driver.name}</td>
          <td>${new Date(driver.created_at).toLocaleDateString()}</td>
          <td>${driverTickets.length}</td>
          <td>$${totalPay.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          <td><span class="badge ${driver.status === 'active' ? 'success' : 'warning'}">${driver.status === 'active' ? 'Active' : 'Inactive'}</span></td>
          <td>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editDriver('${driver.id}', '${driver.driver_code}', '${driver.name}', '${driver.status}')">Edit</button>
              <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #fef3c7; border-color: #fde68a;" onclick="toggleDriverStatus('${driver.id}', '${driver.name}', '${driver.status}')">
                ${driver.status === 'active' ? 'Deactivate' : 'Activate'}
              </button>
              <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #fee2e2; border-color: #fecaca; color: #991b1b;" onclick="deleteDriver('${driver.id}', '${driver.driver_code}', '${driver.name}')">Delete</button>
            </div>
          </td>
        `;
      });
    }

    // Allow Enter key to submit
    document.addEventListener('DOMContentLoaded', function() {
      const passwordInput = document.getElementById('adminPassword');
      if (passwordInput) {
        passwordInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            adminLogin();
          }
        });
      }

      // Check for existing admin session
      checkAdminSession();
    });

    // Check if admin is already logged in
    async function checkAdminSession() {
      const session = localStorage.getItem('b5_admin_session');
      
      if (session) {
        try {
          const { username, loginTime } = JSON.parse(session);
          
          // Check if session is less than 7 days old
          const sessionAge = new Date() - new Date(loginTime);
          const sevenDays = 7 * 24 * 60 * 60 * 1000;
          
          if (sessionAge < sevenDays && username === 'Bridger') {
            // Auto-login admin
            await loadAllData();

            // Hide login screen
            document.getElementById('adminLoginScreen').classList.add('hidden');
            
            // Show sidebar and main content
            document.querySelector('.sidebar').classList.add('show');
            document.querySelector('.main-content').classList.add('show');
            
            // Initialize chart
            setTimeout(() => {
              if (typeof initializeRevenueChart === 'function') {
                initializeRevenueChart();
                if (typeof updateRevenueChart === 'function') {
                  updateRevenueChart();
                }
              }
            }, 100);

            // Initialize payroll
            updateSuggestedPeriod();
            loadPayrollHistory();
          } else {
            // Session expired - clear it
            localStorage.removeItem('b5_admin_session');
          }
        } catch (err) {
          console.error('Session restore error:', err);
          localStorage.removeItem('b5_admin_session');
        }
      }
    }

    // Navigation
    function showSection(sectionId) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });

      // Remove active from all nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });

      // Show selected section
      document.getElementById(sectionId).classList.add('active');

      // Highlight nav item
      event.currentTarget.classList.add('active');

      // Close mobile menu after selection
      if (window.innerWidth <= 768) {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.remove('mobile-open');
      }
    }

    // Mobile menu toggle
    function toggleMobileMenu() {
      const sidebar = document.querySelector('.sidebar');
      sidebar.classList.toggle('mobile-open');
    }

    // Close mobile menu when clicking outside
    document.addEventListener('click', function(event) {
      const sidebar = document.querySelector('.sidebar');
      const menuBtn = document.querySelector('.mobile-menu-btn');
      
      if (window.innerWidth <= 768 && 
          sidebar.classList.contains('mobile-open') &&
          !sidebar.contains(event.target) &&
          !menuBtn.contains(event.target)) {
        sidebar.classList.remove('mobile-open');
      }
    });

    // Modal functions
    function openAddDriverModal() {
      document.getElementById('addDriverModal').classList.add('active');
    }

    function closeAddDriverModal() {
      document.getElementById('addDriverModal').classList.remove('active');
      // Clear form
      document.getElementById('newDriverName').value = '';
      document.getElementById('newDriverCode').value = '';
      document.getElementById('newDriverStatus').value = 'active';
    }

    async function saveDriver() {
      const name = document.getElementById('newDriverName').value;
      const code = document.getElementById('newDriverCode').value;
      const status = document.getElementById('newDriverStatus').value;

      if (!name || !code) {
        alert('Please fill in all required fields');
        return;
      }

      if (code.length !== 2 || !/^\d+$/.test(code)) {
        alert('Driver code must be exactly 2 digits (00-99)');
        return;
      }

      try {
        // Check if code already exists
        const { data: existing } = await supabaseClient
          .from('drivers')
          .select('id')
          .eq('driver_code', code)
          .single();

        if (existing) {
          alert('Driver code already exists. Please use a different code.');
          return;
        }

        // Insert new driver
        const { data, error } = await supabaseClient
          .from('drivers')
          .insert({
            name: name,
            driver_code: code,
            status: status
          })
          .select()
          .single();

        if (error) throw error;

        alert('Driver added successfully!');
        closeAddDriverModal();
        
        // Reload data
        await loadAllData();

      } catch (err) {
        console.error('Error saving driver:', err);
        alert('Error saving driver: ' + err.message);
      }
    }

    // Edit Driver Modal
    let editingDriverId = null;

    function openEditDriverModal() {
      document.getElementById('editDriverModal').classList.add('active');
    }

    function closeEditDriverModal() {
      document.getElementById('editDriverModal').classList.remove('active');
      editingDriverId = null;
      // Clear form
      document.getElementById('editDriverOriginalCode').value = '';
      document.getElementById('editDriverName').value = '';
      document.getElementById('editDriverCode').value = '';
      document.getElementById('editDriverStatus').value = 'active';
    }

    function editDriver(id, code, name, status) {
      editingDriverId = id;
      // Populate edit modal with current driver data
      document.getElementById('editDriverOriginalCode').value = code;
      document.getElementById('editDriverName').value = name;
      document.getElementById('editDriverCode').value = code;
      document.getElementById('editDriverStatus').value = status;
      
      openEditDriverModal();
    }

    async function updateDriver() {
      const name = document.getElementById('editDriverName').value;
      const code = document.getElementById('editDriverCode').value;
      const status = document.getElementById('editDriverStatus').value;
      const originalCode = document.getElementById('editDriverOriginalCode').value;

      if (!name || !code) {
        alert('Please fill in all required fields');
        return;
      }

      if (code.length !== 2 || !/^\d+$/.test(code)) {
        alert('Driver code must be exactly 2 digits (00-99)');
        return;
      }

      try {
        // If code changed, check if new code already exists
        if (code !== originalCode) {
          const { data: existing } = await supabaseClient
            .from('drivers')
            .select('id')
            .eq('driver_code', code)
            .single();

          if (existing && existing.id !== editingDriverId) {
            alert('Driver code already exists. Please use a different code.');
            return;
          }
        }

        // Update driver
        const { error } = await supabaseClient
          .from('drivers')
          .update({
            name: name,
            driver_code: code,
            status: status
          })
          .eq('id', editingDriverId);

        if (error) throw error;

        alert('Driver updated successfully!');
        closeEditDriverModal();
        
        // Reload data
        await loadAllData();

      } catch (err) {
        console.error('Error updating driver:', err);
        alert('Error updating driver: ' + err.message);
      }
    }

    // Toggle Driver Status
    async function toggleDriverStatus(id, name, currentStatus) {
      const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
      const action = newStatus === 'inactive' ? 'deactivate' : 'reactivate';
      
      if (confirm(`Are you sure you want to ${action} ${name}?`)) {
        try {
          const { error } = await supabaseClient
            .from('drivers')
            .update({ status: newStatus })
            .eq('id', id);

          if (error) throw error;

          alert(`Driver ${action}d successfully!`);
          
          // Reload data
          await loadAllData();

        } catch (err) {
          console.error('Error toggling status:', err);
          alert('Error updating driver status: ' + err.message);
        }
      }
    }

    // Delete Driver Modal
    let driverToDelete = null;

    function openDeleteDriverModal() {
      document.getElementById('deleteDriverModal').classList.add('active');
    }

    function closeDeleteDriverModal() {
      document.getElementById('deleteDriverModal').classList.remove('active');
      document.getElementById('deleteConfirmText').value = '';
      document.getElementById('confirmDeleteBtn').disabled = true;
      driverToDelete = null;
    }

    function deleteDriver(id, code, name) {
      driverToDelete = { id, code, name };
      document.getElementById('deleteDriverName').textContent = name;
      document.getElementById('deleteDriverCode').textContent = code;
      openDeleteDriverModal();
    }

    async function confirmDeleteDriver() {
      if (!driverToDelete) return;

      try {
        // Delete driver (tickets will cascade delete due to foreign key)
        const { error } = await supabaseClient
          .from('drivers')
          .delete()
          .eq('id', driverToDelete.id);

        if (error) throw error;

        alert(`Driver ${driverToDelete.name} and all associated data has been permanently deleted.`);
        closeDeleteDriverModal();
        
        // Reload data
        await loadAllData();

      } catch (err) {
        console.error('Error deleting driver:', err);
        alert('Error deleting driver: ' + err.message);
      }
    }

    // Enable delete button only when "DELETE" is typed
    document.addEventListener('DOMContentLoaded', function() {
      const deleteInput = document.getElementById('deleteConfirmText');
      if (deleteInput) {
        deleteInput.addEventListener('input', function() {
          const confirmBtn = document.getElementById('confirmDeleteBtn');
          if (this.value === 'DELETE') {
            confirmBtn.disabled = false;
          } else {
            confirmBtn.disabled = true;
          }
        });
      }
    });

    // Invoice functions
    function generateInvoicePreview() {
      const startDate = document.getElementById('invoiceStartDate').value;
      const endDate = document.getElementById('invoiceEndDate').value;

      if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
      }

      // Get fuel rates
      const fuelBase = parseFloat(document.getElementById('fuelBase').value) || 0;
      const fuelRate = parseFloat(document.getElementById('fuelRate').value) || 0;

      if (!fuelBase || !fuelRate) {
        alert('Please enter fuel base and current fuel rate');
        return;
      }

      // Fetch tickets from Supabase for date range
      supabaseClient
        .from('tickets')
        .select('*')
        .gte('ticket_date', startDate)
        .lte('ticket_date', endDate)
        .order('ticket_date', { ascending: true })
        .then(({ data: tickets, error }) => {
          if (error) {
            console.error('Error fetching tickets:', error);
            alert('Error loading tickets: ' + error.message);
            return;
          }

          if (!tickets || tickets.length === 0) {
            alert('No tickets found for this date range');
            return;
          }

          // Show preview
          document.getElementById('invoicePreviewArea').style.display = 'block';
          document.getElementById('invoicePeriod').textContent = 
            new Date(startDate).toLocaleDateString() + ' – ' + new Date(endDate).toLocaleDateString();
          
          // Generate invoice number
          const invoiceNumber = 'INV-' + new Date().toISOString().slice(0,10).replace(/-/g, '') + '-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0');
          document.getElementById('invoiceNumber').textContent = invoiceNumber;
          document.getElementById('invoiceDate').textContent = new Date().toLocaleDateString();

          // Populate table with real tickets
          const tbody = document.getElementById('invoiceTicketsBody');
          tbody.innerHTML = '';

          tickets.forEach(ticket => {
            const ticketDate = ticket.ticket_date;
            const displayDate = new Date(ticketDate + 'T00:00:00').toLocaleDateString();
            
            const row = tbody.insertRow();
            row.innerHTML = `
              <td>${ticket.ticket_number}</td>
              <td>${displayDate}</td>
              <td>${ticket.truck_number}</td>
              <td style="text-align: center;">1</td>
              <td style="text-align: right;">${ticket.net_tons.toFixed(2)}</td>
              <td style="text-align: right;">$500.00</td>
            `;
          });

          // Calculate totals
          const subtotal = tickets.length * 500;
          document.getElementById('invoiceSubtotal').textContent = '$' + subtotal.toFixed(2);

          // Calculate fuel surcharge
          if (fuelRate > fuelBase) {
            const surchargePerLoad = (84 * 2 / 7) * (fuelRate - fuelBase);
            const totalSurcharge = surchargePerLoad * tickets.length;

            document.getElementById('fuelSurchargeSection').style.display = 'block';
            document.getElementById('fuelSurchargeTotal').textContent = '$' + totalSurcharge.toFixed(2);
            document.getElementById('fuelSurchargeCalc').innerHTML = `
              Base: $${fuelBase.toFixed(2)} · Current: $${fuelRate.toFixed(2)}<br>
              84 miles × 2 / 7 mpg × $${(fuelRate - fuelBase).toFixed(2)} × ${tickets.length} loads<br>
              $${surchargePerLoad.toFixed(2)} per load
            `;

            document.getElementById('invoiceGrandTotal').textContent = '$' + (subtotal + totalSurcharge).toFixed(2);
            
            // Store for saving
            window.currentInvoiceData = {
              invoiceNumber,
              startDate,
              endDate,
              subtotal,
              fuelSurcharge: totalSurcharge,
              total: subtotal + totalSurcharge,
              ticketCount: tickets.length
            };
          } else {
            document.getElementById('fuelSurchargeSection').style.display = 'none';
            document.getElementById('invoiceGrandTotal').textContent = '$' + subtotal.toFixed(2);
            
            // Store for saving
            window.currentInvoiceData = {
              invoiceNumber,
              startDate,
              endDate,
              subtotal,
              fuelSurcharge: 0,
              total: subtotal,
              ticketCount: tickets.length
            };
          }
        });
    }

    async function saveInvoice() {
      if (!window.currentInvoiceData) {
        alert('Please generate invoice preview first');
        return;
      }

      try {
        const { invoiceNumber, startDate, endDate, total, fuelSurcharge, ticketCount } = window.currentInvoiceData;

        // Save invoice to database
        const { data, error } = await supabaseClient
          .from('invoices')
          .insert({
            invoice_number: invoiceNumber,
            date_range_start: startDate,
            date_range_end: endDate,
            total_amount: total,
            fuel_surcharge: fuelSurcharge,
            ticket_count: ticketCount,
            pdf_url: 'generated-on-demand' // PDF generated via print
          })
          .select()
          .single();

        if (error) throw error;

        alert('Invoice saved successfully! Click OK to generate PDF.');

        // Trigger print dialog for PDF generation
        window.print();

        // Clear form and preview after print dialog closes
        setTimeout(() => {
          document.getElementById('invoiceStartDate').value = '';
          document.getElementById('invoiceEndDate').value = '';
          document.getElementById('fuelBase').value = '';
          document.getElementById('fuelRate').value = '';
          document.getElementById('invoicePreviewArea').style.display = 'none';
          window.currentInvoiceData = null;

          // Reload invoices list
          loadInvoicesList();
        }, 500);

      } catch (err) {
        console.error('Error saving invoice:', err);
        alert('Error saving invoice: ' + err.message);
      }
    }

    // Load invoices list
    async function loadInvoicesList() {
      try {
        const { data: invoices, error } = await supabaseClient
          .from('invoices')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        const tbody = document.getElementById('previousInvoicesTable');
        if (!tbody) return;

        tbody.innerHTML = '';

        if (!invoices || invoices.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">No invoices created yet</td></tr>';
          return;
        }

        invoices.forEach(invoice => {
          const row = tbody.insertRow();
          row.innerHTML = `
            <td>${invoice.invoice_number}</td>
            <td>${new Date(invoice.created_at + 'T00:00:00').toLocaleDateString()}</td>
            <td>${new Date(invoice.date_range_start + 'T00:00:00').toLocaleDateString()} – ${new Date(invoice.date_range_end + 'T00:00:00').toLocaleDateString()}</td>
            <td>${invoice.ticket_count}</td>
            <td>$${invoice.total_amount.toFixed(2)}</td>
            <td>
              <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="regenerateInvoicePDF('${invoice.invoice_number}', '${invoice.date_range_start}', '${invoice.date_range_end}')">Print PDF</button>
            </td>
          `;
        });

      } catch (err) {
        console.error('Error loading invoices:', err);
      }
    }

    // Regenerate invoice for printing from saved invoice
    async function regenerateInvoicePDF(invoiceNumber, startDate, endDate) {
      try {
        // Fetch the tickets for this date range
        const { data: tickets, error } = await supabaseClient
          .from('tickets')
          .select('*')
          .gte('ticket_date', startDate)
          .lte('ticket_date', endDate)
          .order('ticket_date', { ascending: true });

        if (error) throw error;

        if (!tickets || tickets.length === 0) {
          alert('No tickets found for this invoice period');
          return;
        }

        // Populate the preview with the saved invoice data
        document.getElementById('invoicePreviewArea').style.display = 'block';
        document.getElementById('invoiceNumber').textContent = invoiceNumber;
        document.getElementById('invoiceDate').textContent = new Date().toLocaleDateString();
        document.getElementById('invoicePeriod').textContent = 
          new Date(startDate + 'T00:00:00').toLocaleDateString() + ' – ' + new Date(endDate + 'T00:00:00').toLocaleDateString();

        // Populate table
        const tbody = document.getElementById('invoiceTicketsBody');
        tbody.innerHTML = '';

        tickets.forEach(ticket => {
          const ticketDate = ticket.ticket_date;
          const displayDate = new Date(ticketDate + 'T00:00:00').toLocaleDateString();
          
          const row = tbody.insertRow();
          row.innerHTML = `
            <td>${ticket.ticket_number}</td>
            <td>${displayDate}</td>
            <td>${ticket.truck_number}</td>
            <td style="text-align: center;">1</td>
            <td style="text-align: right;">${ticket.net_tons.toFixed(2)}</td>
            <td style="text-align: right;">$500.00</td>
          `;
        });

        // Calculate totals
        const subtotal = tickets.length * 500;
        document.getElementById('invoiceSubtotal').textContent = '$' + subtotal.toFixed(2);

        // Get fuel surcharge from saved invoice
        const { data: savedInvoice } = await supabaseClient
          .from('invoices')
          .select('fuel_surcharge')
          .eq('invoice_number', invoiceNumber)
          .single();

        const fuelSurcharge = savedInvoice?.fuel_surcharge || 0;

        if (fuelSurcharge > 0) {
          document.getElementById('fuelSurchargeSection').style.display = 'block';
          document.getElementById('fuelSurchargeTotal').textContent = '$' + fuelSurcharge.toFixed(2);
          document.getElementById('fuelSurchargeCalc').innerHTML = 'See original invoice for calculation';
          document.getElementById('invoiceGrandTotal').textContent = '$' + (subtotal + fuelSurcharge).toFixed(2);
        } else {
          document.getElementById('fuelSurchargeSection').style.display = 'none';
          document.getElementById('invoiceGrandTotal').textContent = '$' + subtotal.toFixed(2);
        }

        // Scroll to invoice and trigger print
        document.getElementById('invoicePreviewArea').scrollIntoView({ behavior: 'smooth' });
        
        setTimeout(() => {
          window.print();
        }, 500);

      } catch (err) {
        console.error('Error regenerating invoice:', err);
        alert('Error loading invoice: ' + err.message);
      }
    }


    // ============================================
    // PAYROLL FUNCTIONS
    // ============================================

    let currentPayrollData = [];

    // Update suggested period (2 weeks behind)
    function updateSuggestedPeriod() {
      const today = new Date();
      const twoWeeksAgo = new Date(today);
      twoWeeksAgo.setDate(today.getDate() - 14);
      
      // Find the Monday of that week
      const dayOfWeek = twoWeeksAgo.getDay();
      const daysToMonday = (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
      const monday = new Date(twoWeeksAgo);
      monday.setDate(twoWeeksAgo.getDate() - daysToMonday);
      
      // Find the Sunday
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      
      const periodText = monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + 
                        ' - ' + 
                        sunday.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      
      document.getElementById('suggestedPeriod').textContent = periodText;
      
      // Store for quick use
      window.suggestedStart = monday.toISOString().split('T')[0];
      window.suggestedEnd = sunday.toISOString().split('T')[0];
    }

    function useSuggestedDates() {
      document.getElementById('payrollStartDate').value = window.suggestedStart;
      document.getElementById('payrollEndDate').value = window.suggestedEnd;
    }

    async function generatePayroll() {
      const startDate = document.getElementById('payrollStartDate').value;
      const endDate = document.getElementById('payrollEndDate').value;

      if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
      }

      try {
        // Fetch UNPAID tickets for date range
        const { data: tickets, error } = await supabaseClient
          .from('tickets')
          .select('*')
          .gte('ticket_date', startDate)
          .lte('ticket_date', endDate)
          .eq('paid', false)
          .order('driver_name', { ascending: true });

        if (error) throw error;

        if (!tickets || tickets.length === 0) {
          alert('No unpaid tickets found for this date range');
          return;
        }

        // Group by driver
        const driverMap = {};
        tickets.forEach(ticket => {
          if (!driverMap[ticket.driver_id]) {
            driverMap[ticket.driver_id] = {
              driver_id: ticket.driver_id,
              driver_name: ticket.driver_name,
              tickets: [],
              loads: 0,
              base_pay: 0,
              bonus_pay: 0,
              total_pay: 0,
              selected: true
            };
          }
          
          driverMap[ticket.driver_id].tickets.push(ticket);
          driverMap[ticket.driver_id].loads++;
          driverMap[ticket.driver_id].base_pay += ticket.driver_pay;
          driverMap[ticket.driver_id].bonus_pay += ticket.bonus_pay;
          driverMap[ticket.driver_id].total_pay += (ticket.driver_pay + ticket.bonus_pay);
        });

        currentPayrollData = Object.values(driverMap);

        // Display preview
        displayPayrollPreview(startDate, endDate);

      } catch (err) {
        console.error('Error generating payroll:', err);
        alert('Error generating payroll: ' + err.message);
      }
    }

    function displayPayrollPreview(startDate, endDate) {
      const tbody = document.getElementById('payrollTableBody');
      tbody.innerHTML = '';

      const startFormatted = new Date(startDate + 'T00:00:00').toLocaleDateString();
      const endFormatted = new Date(endDate + 'T00:00:00').toLocaleDateString();
      document.getElementById('payrollPeriodDisplay').textContent = `${startFormatted} - ${endFormatted}`;

      let totalLoads = 0;
      let totalBase = 0;
      let totalBonus = 0;
      let totalPay = 0;

      currentPayrollData.forEach((driver, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td style="text-align: center;">
            <input type="checkbox" ${driver.selected ? 'checked' : ''} onchange="toggleDriverPayment(${index}, this.checked)" style="width: 20px; height: 20px; cursor: pointer;">
          </td>
          <td>${driver.driver_name}</td>
          <td style="text-align: center;">${driver.loads}</td>
          <td style="text-align: right;">$${driver.base_pay.toFixed(2)}</td>
          <td style="text-align: right;">$${driver.bonus_pay.toFixed(2)}</td>
          <td style="text-align: right; font-weight: 600;">$${driver.total_pay.toFixed(2)}</td>
          <td>
            <button class="btn btn-secondary" onclick="viewDriverTickets(${index})" style="padding: 6px 12px; font-size: 12px;">Details</button>
          </td>
        `;

        if (driver.selected) {
          totalLoads += driver.loads;
          totalBase += driver.base_pay;
          totalBonus += driver.bonus_pay;
          totalPay += driver.total_pay;
        }
      });

      document.getElementById('payrollTotalLoads').textContent = totalLoads;
      document.getElementById('payrollTotalBase').textContent = '$' + totalBase.toFixed(2);
      document.getElementById('payrollTotalBonus').textContent = '$' + totalBonus.toFixed(2);
      document.getElementById('payrollGrandTotal').textContent = '$' + totalPay.toFixed(2);

      document.getElementById('payrollPreviewArea').style.display = 'block';
      document.getElementById('payrollPreviewArea').scrollIntoView({ behavior: 'smooth' });
    }

    function toggleDriverPayment(index, checked) {
      currentPayrollData[index].selected = checked;
      
      // Recalculate totals
      let totalLoads = 0;
      let totalBase = 0;
      let totalBonus = 0;
      let totalPay = 0;

      currentPayrollData.forEach(driver => {
        if (driver.selected) {
          totalLoads += driver.loads;
          totalBase += driver.base_pay;
          totalBonus += driver.bonus_pay;
          totalPay += driver.total_pay;
        }
      });

      document.getElementById('payrollTotalLoads').textContent = totalLoads;
      document.getElementById('payrollTotalBase').textContent = '$' + totalBase.toFixed(2);
      document.getElementById('payrollTotalBonus').textContent = '$' + totalBonus.toFixed(2);
      document.getElementById('payrollGrandTotal').textContent = '$' + totalPay.toFixed(2);
    }

    function viewDriverTickets(index) {
      const driver = currentPayrollData[index];
      let ticketList = `TICKET BREAKDOWN - ${driver.driver_name}\n\n`;
      ticketList += `Ticket #      Date          Truck      Net Tons    Pay\n`;
      ticketList += `${'─'.repeat(60)}\n`;

      driver.tickets.forEach(ticket => {
        const date = new Date(ticket.ticket_date + 'T00:00:00').toLocaleDateString();
        const pay = ticket.driver_pay + ticket.bonus_pay;
        const bonus = ticket.bonus_pay > 0 ? ' + $10 (3rd)' : '';
        ticketList += `${ticket.ticket_number.padEnd(12)} ${date.padEnd(12)} ${ticket.truck_number.padEnd(10)} ${ticket.net_tons.toFixed(2).padEnd(10)} $${pay.toFixed(2)}${bonus}\n`;
      });

      ticketList += `\nTotal: ${driver.loads} loads = $${driver.total_pay.toFixed(2)}`;

      alert(ticketList);
    }

    async function savePayroll() {
      const selectedDrivers = currentPayrollData.filter(d => d.selected);
      
      if (selectedDrivers.length === 0) {
        alert('Please select at least one driver to pay');
        return;
      }

      const startDate = document.getElementById('payrollStartDate').value;
      const endDate = document.getElementById('payrollEndDate').value;
      const notes = document.getElementById('payrollNotes').value;

      const totalAmount = selectedDrivers.reduce((sum, d) => sum + d.total_pay, 0);

      if (!confirm(`Mark ${selectedDrivers.length} driver(s) as paid for $${totalAmount.toFixed(2)}?\n\nThis will mark all their tickets in this period as PAID.`)) {
        return;
      }

      try {
        // Create payroll record
        const { data: payrollRecord, error: payrollError } = await supabaseClient
          .from('payroll_records')
          .insert({
            period_start: startDate,
            period_end: endDate,
            total_amount: totalAmount,
            notes: notes || null
          })
          .select()
          .single();

        if (payrollError) throw payrollError;

        // Create payroll items for each driver
        const payrollItems = selectedDrivers.map(driver => ({
          payroll_id: payrollRecord.id,
          driver_id: driver.driver_id,
          driver_name: driver.driver_name,
          ticket_count: driver.loads,
          base_pay: driver.base_pay,
          bonus_pay: driver.bonus_pay,
          total_pay: driver.total_pay
        }));

        const { error: itemsError } = await supabaseClient
          .from('payroll_items')
          .insert(payrollItems);

        if (itemsError) throw itemsError;

        // Mark all tickets as paid
        const allTicketIds = selectedDrivers.flatMap(d => d.tickets.map(t => t.id));

        const { error: updateError } = await supabaseClient
          .from('tickets')
          .update({ 
            paid: true,
            payroll_id: payrollRecord.id
          })
          .in('id', allTicketIds);

        if (updateError) throw updateError;

        alert('Payroll saved successfully!');
        
        // Clear form
        cancelPayroll();
        
        // Reload data
        await loadAllData();
        loadPayrollHistory();

      } catch (err) {
        console.error('Error saving payroll:', err);
        alert('Error saving payroll: ' + err.message);
      }
    }

    function cancelPayroll() {
      document.getElementById('payrollPreviewArea').style.display = 'none';
      document.getElementById('payrollStartDate').value = '';
      document.getElementById('payrollEndDate').value = '';
      document.getElementById('payrollNotes').value = '';
      currentPayrollData = [];
    }

    async function loadPayrollHistory() {
      try {
        const { data: payrolls, error } = await supabaseClient
          .from('payroll_records')
          .select(`
            *,
            payroll_items(count)
          `)
          .order('created_at', { ascending: false });

        if (error) throw error;

        const tbody = document.getElementById('payrollHistoryTable');
        tbody.innerHTML = '';

        if (!payrolls || payrolls.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">No payroll records yet</td></tr>';
          return;
        }

        payrolls.forEach(payroll => {
          const row = tbody.insertRow();
          const startDate = new Date(payroll.period_start + 'T00:00:00').toLocaleDateString();
          const endDate = new Date(payroll.period_end + 'T00:00:00').toLocaleDateString();
          const paidDate = new Date(payroll.paid_date + 'T00:00:00').toLocaleDateString();
          const driverCount = payroll.payroll_items?.[0]?.count || 0;

          row.innerHTML = `
            <td>${startDate} - ${endDate}</td>
            <td>${paidDate}</td>
            <td style="text-align: center;">${driverCount}</td>
            <td style="text-align: right; font-weight: 600;">$${payroll.total_amount.toFixed(2)}</td>
            <td style="text-align: center;">
              <button class="btn btn-secondary" onclick="viewPayrollPDF('${payroll.id}')" style="padding: 6px 12px; font-size: 12px;">📄 PDF</button>
            </td>
          `;
        });

      } catch (err) {
        console.error('Error loading payroll history:', err);
      }
    }

    async function viewPayrollPDF(payrollId) {
      alert('PDF generation for payroll coming in next update! For now, you can export from the preview.');
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Clear session
        localStorage.removeItem('b5_admin_session');
        
        // Hide sidebar and main content
        document.querySelector('.sidebar').classList.remove('show');
        document.querySelector('.main-content').classList.remove('show');
        
        // Show login screen
        document.getElementById('adminLoginScreen').classList.remove('hidden');
        
        // Clear form
        document.getElementById('adminUsername').value = '';
        document.getElementById('adminPassword').value = '';
        
        // Clear data
        allTickets = [];
        allDrivers = [];
      }
    }

    // Set default dates for invoice (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);

    document.getElementById('invoiceEndDate').valueAsDate = today;
    document.getElementById('invoiceStartDate').valueAsDate = thirtyDaysAgo;

    // Revenue Chart Setup
    let revenueChart = null;

    function initializeRevenueChart(chartType = 'line') {
      const ctx = document.getElementById('revenueChart').getContext('2d');
      
      // Start with empty data - will be populated by updateRevenueChart
      const initialData = {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        datasets: [{
          label: 'Revenue',
          data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
          borderColor: '#dc2626',
          backgroundColor: chartType === 'bar' ? 'rgba(220, 38, 38, 0.8)' : 'rgba(220, 38, 38, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: chartType === 'bar' ? 0 : 3,
          pointBackgroundColor: '#dc2626',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: chartType === 'bar' ? 0 : 5,
          pointHoverRadius: chartType === 'bar' ? 0 : 7
        }]
      };

      revenueChart = new Chart(ctx, {
        type: chartType,
        data: initialData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: '2025 - Monthly Revenue',
              color: '#111827',
              font: {
                size: 16,
                weight: '600'
              },
              padding: {
                bottom: 20
              }
            },
            tooltip: {
              backgroundColor: '#111827',
              padding: 12,
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#dc2626',
              borderWidth: 1,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return '$' + context.parsed.y.toLocaleString();
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: '#f3f4f6',
                drawBorder: false
              },
              ticks: {
                callback: function(value) {
                  return '$' + (value / 1000) + 'k';
                },
                color: '#6b7280',
                font: {
                  size: 12
                }
              }
            },
            x: {
              grid: {
                display: false,
                drawBorder: false
              },
              ticks: {
                color: '#6b7280',
                font: {
                  size: 12
                }
              }
            }
          }
        }
      });
    }

    function updateRevenueChart() {
      const driver = document.getElementById('chartFilterDriver').value;
      const year = parseInt(document.getElementById('chartFilterYear').value);
      const view = document.getElementById('chartFilterView').value;
      const month = document.getElementById('chartFilterMonth').value;

      // Filter tickets by driver and year
      let filteredTickets = allTickets.filter(t => {
        const ticketDate = new Date(t.ticket_date);
        const ticketYear = ticketDate.getFullYear();
        
        // Filter by year
        if (ticketYear !== year) return false;
        
        // Filter by driver if selected
        if (driver !== 'all' && t.driver_name !== driver) return false;
        
        return true;
      });

      let labels, data, chartType = 'line';
      
      if (view === 'monthly') {
        if (month !== 'all') {
          // Show daily data for specific month
          const selectedMonth = parseInt(month);
          const daysInMonth = new Date(year, selectedMonth, 0).getDate();
          labels = Array.from({length: daysInMonth}, (_, i) => (i + 1).toString());
          
          // Calculate revenue per day
          data = new Array(daysInMonth).fill(0);
          filteredTickets.forEach(t => {
            const ticketDate = new Date(t.ticket_date);
            if (ticketDate.getMonth() + 1 === selectedMonth) {
              const day = ticketDate.getDate() - 1; // 0-indexed
              // Scale to client rate ($500 per ticket)
              data[day] += 500;
            }
          });

          const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                            'July', 'August', 'September', 'October', 'November', 'December'];
          revenueChart.options.plugins.title.text = monthNames[selectedMonth] + ' ' + year + ' - Daily Revenue';
        } else {
          // Show monthly data for full year
          labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          data = new Array(12).fill(0);
          
          filteredTickets.forEach(t => {
            const ticketDate = new Date(t.ticket_date);
            const monthIndex = ticketDate.getMonth();
            // Scale to client rate ($500 per ticket)
            data[monthIndex] += 500;
          });

          revenueChart.options.plugins.title.text = year + ' - Monthly Revenue';
        }
      } else if (view === 'weekly') {
        // Last 8 weeks
        labels = [];
        data = new Array(8).fill(0);
        const now = new Date();
        
        for (let i = 7; i >= 0; i--) {
          const weekStart = new Date(now);
          weekStart.setDate(now.getDate() - (i * 7));
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 6);
          
          labels.push(`Week ${8 - i}`);
          
          filteredTickets.forEach(t => {
            const ticketDate = new Date(t.ticket_date);
            if (ticketDate >= weekStart && ticketDate <= weekEnd) {
              data[7 - i] += 500; // Scale to client rate
            }
          });
        }
        
        revenueChart.options.plugins.title.text = 'Last 8 Weeks - Revenue';
      } else if (view === 'quarter') {
        labels = ['Q1', 'Q2', 'Q3', 'Q4'];
        data = [0, 0, 0, 0];
        chartType = 'bar';
        
        filteredTickets.forEach(t => {
          const ticketDate = new Date(t.ticket_date);
          const monthIndex = ticketDate.getMonth();
          const quarter = Math.floor(monthIndex / 3);
          data[quarter] += 500; // Scale to client rate
        });

        revenueChart.options.plugins.title.text = year + ' - Quarterly Revenue';
      }

      // Update chart type if needed
      if (revenueChart.config.type !== chartType) {
        revenueChart.destroy();
        initializeRevenueChart(chartType);
      }

      // Update chart
      revenueChart.data.labels = labels;
      revenueChart.data.datasets[0].data = data;
      
      // Update styling based on chart type
      if (chartType === 'bar') {
        revenueChart.data.datasets[0].backgroundColor = 'rgba(220, 38, 38, 0.8)';
        revenueChart.data.datasets[0].borderColor = 'rgba(220, 38, 38, 1)';
        revenueChart.data.datasets[0].borderWidth = 0;
      } else {
        revenueChart.data.datasets[0].backgroundColor = 'rgba(220, 38, 38, 0.1)';
        revenueChart.data.datasets[0].borderColor = '#dc2626';
        revenueChart.data.datasets[0].borderWidth = 3;
      }
      
      revenueChart.update();

      // Update summary stats with real data
      const total = data.reduce((a, b) => a + b, 0);
      const tickets = filteredTickets.length;
      document.getElementById('chartTotalRevenue').textContent = '$' + total.toLocaleString();
      document.getElementById('chartTotalTickets').textContent = tickets;
      document.getElementById('chartAvgPerTicket').textContent = tickets > 0 ? '$' + Math.round(total / tickets) : '$0';
    }

    function handleViewChange() {
      const view = document.getElementById('chartFilterView').value;
      const monthFilterGroup = document.getElementById('monthFilterGroup');
      
      // Show/hide month filter based on view
      if (view === 'monthly') {
        monthFilterGroup.style.display = 'flex';
      } else {
        monthFilterGroup.style.display = 'none';
        document.getElementById('chartFilterMonth').value = 'all';
      }
      
      updateRevenueChart();
    }

    // Initialize chart when page loads
    window.addEventListener('load', function() {
      initializeRevenueChart();
    });
  </script>
</body>
</html>
